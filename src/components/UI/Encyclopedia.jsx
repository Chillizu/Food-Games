import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import foodsData from '../../data/foods.json';
import './Encyclopedia.module.css';

const Encyclopedia = ({ onClose }) => {
  const [selectedCategory, setSelectedCategory] = useState('all');
  const [selectedSDG, setSelectedSDG] = useState('all');
  const [searchTerm, setSearchTerm] = useState('');
  const [sortBy, setSortBy] = useState('name');
  const [collectedFoods, setCollectedFoods] = useState([]);
  const [viewMode, setViewMode] = useState('grid'); // 'grid' or 'list'
  const [selectedFood, setSelectedFood] = useState(null);

  // SDG ÁõÆÊ†áÊò†Â∞Ñ
  const sdgGoals = {
    'SDG1': { name: 'Êó†Ë¥´Á©∑', icon: 'üè†', color: '#4ade80' },
    'SDG2': { name: 'Èõ∂È••È•ø', icon: 'üçé', color: '#f87171' },
    'SDG3': { name: 'ËâØÂ•ΩÂÅ•Â∫∑', icon: '‚ù§Ô∏è', color: '#fbbf24' },
    'SDG4': { name: '‰ºòË¥®ÊïôËÇ≤', icon: 'üìö', color: '#60a5fa' },
    'SDG5': { name: 'ÊÄßÂà´Âπ≥Á≠â', icon: '‚ôÄÔ∏è', color: '#ec4899' },
    'SDG6': { name: 'Ê∏ÖÊ¥ÅÈ•ÆÊ∞¥', icon: 'üíß', color: '#06b6d4' },
    'SDG7': { name: 'Âªâ‰ª∑ËÉΩÊ∫ê', icon: '‚ö°', color: '#f59e0b' },
    'SDG8': { name: '‰ΩìÈù¢Â∑•‰Ωú', icon: 'üíº', color: '#8b5cf6' },
    'SDG9': { name: 'Â∑•‰∏öÂàõÊñ∞', icon: 'üîß', color: '#a78bfa' },
    'SDG10': { name: 'ÂáèÂ∞ë‰∏çÂπ≥Á≠â', icon: '‚öñÔ∏è', color: '#f97316' },
    'SDG11': { name: 'ÂèØÊåÅÁª≠ÂüéÂ∏Ç', icon: 'üèôÔ∏è', color: '#84cc16' },
    'SDG12': { name: 'Ë¥üË¥£‰ªªÊ∂àË¥π', icon: '‚ôªÔ∏è', color: '#10b981' },
    'SDG13': { name: 'Ê∞îÂÄôË°åÂä®', icon: 'üåç', color: '#06b6d4' },
    'SDG14': { name: 'Ê∞¥‰∏ãÁîüÁâ©', icon: 'üê†', color: '#0ea5e9' },
    'SDG15': { name: 'ÈôÜÂú∞ÁîüÁâ©', icon: 'üå≥', color: '#22c55e' },
    'SDG16': { name: 'ÂíåÂπ≥Ê≠£‰πâ', icon: 'üïäÔ∏è', color: '#64748b' },
    'SDG17': { name: '‰ºô‰º¥ÂÖ≥Á≥ª', icon: 'ü§ù', color: '#6366f1' }
  };

  // Á®ÄÊúâÂ∫¶Êò†Â∞Ñ
  const rarityMap = {
    'common': { name: 'ÊôÆÈÄö', color: '#9ca3af', bgColor: '#f3f4f6' },
    'uncommon': { name: 'Á®ÄÊúâ', color: '#10b981', bgColor: '#d1fae5' },
    'rare': { name: 'Âè≤ËØó', color: '#3b82f6', bgColor: '#dbeafe' },
    'legendary': { name: '‰º†ËØ¥', color: '#f59e0b', bgColor: '#fef3c7' }
  };

  // ÂàùÂßãÂåñÊî∂ÈõÜÁä∂ÊÄÅ
  useEffect(() => {
    // ‰ªé localStorage Ëé∑ÂèñÂ∑≤Êî∂ÈõÜÁöÑÈ£üÊùê
    const savedCollected = localStorage.getItem('collectedFoods');
    if (savedCollected) {
      setCollectedFoods(JSON.parse(savedCollected));
    } else {
      // ÈªòËÆ§Ëß£ÈîÅÊâÄÊúâÊôÆÈÄöÈ£üÊùê
      const initialCollected = foodsData.foods
        .filter(food => food.rarity === 'common')
        .map(food => food.id);
      setCollectedFoods(initialCollected);
      localStorage.setItem('collectedFoods', JSON.stringify(initialCollected));
    }
  }, []);

  // ‰øùÂ≠òÊî∂ÈõÜÁä∂ÊÄÅ
  const saveCollectedFoods = (newCollected) => {
    setCollectedFoods(newCollected);
    localStorage.setItem('collectedFoods', JSON.stringify(newCollected));
  };

  // ÂèëÁé∞Êñ∞È£üÊùê
  const discoverFood = (foodId) => {
    if (!collectedFoods.includes(foodId)) {
      const newCollected = [...collectedFoods, foodId];
      saveCollectedFoods(newCollected);
    }
  };

  // ËøáÊª§ÂíåÊéíÂ∫èÈ£üÊùê
  const filteredFoods = foodsData.foods
    .filter(food => {
      // Á±ªÂà´ËøáÊª§
      if (selectedCategory !== 'all' && food.category !== selectedCategory) return false;
      
      // SDG ËøáÊª§
      if (selectedSDG !== 'all' && !food.sdgGoals.includes(selectedSDG)) return false;
      
      // ÊêúÁ¥¢ËøáÊª§
      if (searchTerm && !food.name.toLowerCase().includes(searchTerm.toLowerCase()) && 
          !food.description.toLowerCase().includes(searchTerm.toLowerCase())) return false;
      
      return true;
    })
    .sort((a, b) => {
      switch (sortBy) {
        case 'name':
          return a.name.localeCompare(b.name);
        case 'rarity':
          const rarityOrder = { 'common': 0, 'uncommon': 1, 'rare': 2, 'legendary': 3 };
          return rarityOrder[b.rarity] - rarityOrder[a.rarity];
        case 'sdg':
          return a.sdgGoals.length - b.sdgGoals.length;
        default:
          return 0;
      }
    });

  // Ëé∑ÂèñÊâÄÊúâÂèØÁî®ÁöÑ SDG ÁõÆÊ†á
  const availableSDGs = [...new Set(foodsData.foods.flatMap(food => food.sdgGoals))];

  // Ëé∑ÂèñÊî∂ÈõÜÁªüËÆ°
  const collectionStats = {
    total: foodsData.foods.length,
    collected: collectedFoods.length,
    byCategory: foodsData.categories ? Object.keys(foodsData.categories).reduce((acc, category) => {
      acc[category] = foodsData.foods.filter(food => food.category === category).length;
      return acc;
    }, {}) : {},
    byRarity: Object.keys(rarityMap).reduce((acc, rarity) => {
      acc[rarity] = foodsData.foods.filter(food => food.rarity === rarity).length;
      return acc;
    }, {})
  };

  // Ê∏≤Êüì SDG Ê†áÁ≠æ
  const renderSDGBadges = (sdgGoals) => {
    return (
      <div className="sdg-badges">
        {sdgGoals.map(sdg => (
          <span 
            key={sdg} 
            className="sdg-badge"
            style={{ backgroundColor: sdgGoals[sdg]?.color || '#e5e7eb' }}
            title={sdgGoals[sdg]?.name || sdg}
          >
            {sdgGoals[sdg]?.icon || 'üéØ'}
          </span>
        ))}
      </div>
    );
  };

  // Ê∏≤ÊüìÂçï‰∏™È£üÊùêÂç°Áâá
  const renderFoodCard = (food) => {
    const isCollected = collectedFoods.includes(food.id);
    const rarity = rarityMap[food.rarity] || rarityMap.common;
    
    return (
      <motion.div
        key={food.id}
        className={`food-card ${isCollected ? 'collected' : 'locked'} ${viewMode}`}
        whileHover={{ y: -5 }}
        whileTap={{ scale: 0.95 }}
        onClick={() => isCollected && setSelectedFood(food)}
      >
        <div className="card-header">
          <div className="food-emoji">{food.emoji}</div>
          <div className="card-title">
            <h3>{food.name}</h3>
            <div className="rarity-badge" style={{ 
              color: rarity.color, 
              backgroundColor: rarity.bgColor 
            }}>
              {rarity.name}
            </div>
          </div>
        </div>
        
        <div className="card-content">
          <p className="description">{food.description}</p>
          
          {isCollected ? (
            <>
              <div className="stats-grid">
                <div className="stat-item">
                  <span className="stat-label">Á¢≥Ë∂≥Ëøπ</span>
                  <div className="stat-bar">
                    <div 
                      className="stat-fill carbon" 
                      style={{ width: `${food.carbonFootprint * 100}%` }}
                    ></div>
                  </div>
                </div>
                <div className="stat-item">
                  <span className="stat-label">Ê∞¥ËÄó</span>
                  <div className="stat-bar">
                    <div 
                      className="stat-fill water" 
                      style={{ width: `${food.waterUsage * 100}%` }}
                    ></div>
                  </div>
                </div>
                <div className="stat-item">
                  <span className="stat-label">ÂÅ•Â∫∑Â∫¶</span>
                  <div className="stat-bar">
                    <div 
                      className="stat-fill health" 
                      style={{ width: `${food.healthScore * 100}%` }}
                    ></div>
                  </div>
                </div>
              </div>
              
              <div className="sdg-section">
                <h4>SDG Ë¥°ÁåÆ</h4>
                <div className="sdg-list">
                  {food.sdgGoals.map(sdg => (
                    <span 
                      key={sdg} 
                      className="sdg-item"
                      style={{ backgroundColor: sdgGoals[sdg]?.color + '20' }}
                      title={sdgGoals[sdg]?.name}
                    >
                      {sdgGoals[sdg]?.icon} {sdgGoals[sdg]?.name}
                    </span>
                  ))}
                </div>
              </div>
              
              <div className="fun-fact">
                <span className="fact-icon">üí°</span>
                <p>{food.funFact}</p>
              </div>
            </>
          ) : (
            <div className="unlock-info">
              <span className="lock-icon">üîí</span>
              <p>{food.unlockCondition}</p>
            </div>
          )}
        </div>
        
        <div className="card-footer">
          {isCollected ? (
            <span className="collected-status">Â∑≤Êî∂ÈõÜ</span>
          ) : (
            <span className="locked-status">Êú™Êî∂ÈõÜ</span>
          )}
        </div>
      </motion.div>
    );
  };

  // Ê∏≤ÊüìÈ£üÊùêËØ¶ÊÉÖ
  const renderFoodDetail = (food) => {
    const rarity = rarityMap[food.rarity] || rarityMap.common;
    
    return (
      <motion.div 
        className="food-detail-modal"
        initial={{ opacity: 0, scale: 0.9 }}
        animate={{ opacity: 1, scale: 1 }}
        exit={{ opacity: 0, scale: 0.9 }}
      >
        <div className="detail-header">
          <div className="detail-emoji">{food.emoji}</div>
          <div className="detail-title">
            <h2>{food.name}</h2>
            <div className="rarity-badge" style={{ 
              color: rarity.color, 
              backgroundColor: rarity.bgColor 
            }}>
              {rarity.name}
            </div>
          </div>
          <button 
            className="close-detail"
            onClick={() => setSelectedFood(null)}
          >
            ‚úï
          </button>
        </div>
        
        <div className="detail-content">
          <div className="detail-section">
            <h3>Âü∫Êú¨‰ø°ÊÅØ</h3>
            <p>{food.description}</p>
          </div>
          
          <div className="detail-section">
            <h3>ÁéØÂ¢ÉÂΩ±Âìç</h3>
            <div className="impact-stats">
              <div className="impact-item">
                <span className="impact-label">Á¢≥Ë∂≥Ëøπ</span>
                <div className="impact-bar">
                  <div 
                    className="impact-fill carbon" 
                    style={{ width: `${food.carbonFootprint * 100}%` }}
                  ></div>
                </div>
                <span className="impact-value">{(food.carbonFootprint * 100).toFixed(0)}%</span>
              </div>
              <div className="impact-item">
                <span className="impact-label">Ê∞¥ËÄó</span>
                <div className="impact-bar">
                  <div 
                    className="impact-fill water" 
                    style={{ width: `${food.waterUsage * 100}%` }}
                  ></div>
                </div>
                <span className="impact-value">{(food.waterUsage * 100).toFixed(0)}%</span>
              </div>
              <div className="impact-item">
                <span className="impact-label">ÂúüÂú∞Âç†Áî®</span>
                <div className="impact-bar">
                  <div 
                    className="impact-fill land" 
                    style={{ width: `${food.landUsage * 100}%` }}
                  ></div>
                </div>
                <span className="impact-value">{(food.landUsage * 100).toFixed(0)}%</span>
              </div>
              <div className="impact-item">
                <span className="impact-label">ÂÅ•Â∫∑ÊåáÊï∞</span>
                <div className="impact-bar">
                  <div 
                    className="impact-fill health" 
                    style={{ width: `${food.healthScore * 100}%` }}
                  ></div>
                </div>
                <span className="impact-value">{(food.healthScore * 100).toFixed(0)}%</span>
              </div>
            </div>
          </div>
          
          <div className="detail-section">
            <h3>SDG Ë¥°ÁåÆ</h3>
            <div className="sdg-detail-grid">
              {food.sdgGoals.map(sdg => (
                <div key={sdg} className="sdg-detail-item">
                  <div 
                    className="sdg-icon"
                    style={{ backgroundColor: sdgGoals[sdg]?.color + '20' }}
                  >
                    {sdgGoals[sdg]?.icon}
                  </div>
                  <div className="sdg-info">
                    <h4>{sdgGoals[sdg]?.name}</h4>
                    <p>{sdg}</p>
                  </div>
                </div>
              ))}
            </div>
          </div>
          
          <div className="detail-section">
            <h3>Ë∂£Âë≥Áü•ËØÜ</h3>
            <div className="fun-fact-detail">
              <span className="fact-icon">üí°</span>
              <p>{food.funFact}</p>
            </div>
          </div>
          
          <div className="detail-section">
            <h3>Ëß£ÈîÅÊù°‰ª∂</h3>
            <div className="unlock-condition">
              <span className="condition-icon">üîì</span>
              <p>{food.unlockCondition}</p>
            </div>
          </div>
        </div>
      </motion.div>
    );
  };

  return (
    <motion.div 
      className="encyclopedia-overlay"
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      onClick={(e) => e.target === e.currentTarget && onClose()}
    >
      <motion.div 
        className="encyclopedia-container"
        initial={{ y: 50, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        exit={{ y: 50, opacity: 0 }}
        onClick={(e) => e.stopPropagation()}
      >
        {/* Â§¥ÈÉ® */}
        <div className="encyclopedia-header">
          <div className="header-left">
            <h1>È£üÊùêÂõæÈâ¥</h1>
            <div className="collection-progress">
              <span className="progress-text">
                Â∑≤Êî∂ÈõÜ {collectedFoods.length} / {foodsData.foods.length}
              </span>
              <div className="progress-bar">
                <div 
                  className="progress-fill"
                  style={{ width: `${(collectedFoods.length / foodsData.foods.length) * 100}%` }}
                ></div>
              </div>
            </div>
          </div>
          <div className="header-right">
            <button 
              className="view-toggle"
              onClick={() => setViewMode(viewMode === 'grid' ? 'list' : 'grid')}
            >
              {viewMode === 'grid' ? 'üìã ÂàóË°®' : '‚äû ÁΩëÊ†º'}
            </button>
            <button className="close-btn" onClick={onClose}>
              ‚úï
            </button>
          </div>
        </div>

        {/* ÁªüËÆ°‰ø°ÊÅØ */}
        <div className="encyclopedia-stats">
          <div className="stat-card">
            <h3>Êî∂ÈõÜËøõÂ∫¶</h3>
            <div className="stat-value">
              {Math.round((collectedFoods.length / foodsData.foods.length) * 100)}%
            </div>
            <div className="stat-detail">
              {collectedFoods.length} / {foodsData.foods.length} ÁßçÈ£üÊùê
            </div>
          </div>
          
          {foodsData.categories && (
            <div className="stat-card">
              <h3>Á±ªÂà´ÂàÜÂ∏É</h3>
              <div className="category-stats">
                {Object.entries(foodsData.categories).map(([key, category]) => {
                  const count = foodsData.foods.filter(food => food.category === key).length;
                  const collectedCount = foodsData.foods
                    .filter(food => food.category === key && collectedFoods.includes(food.id))
                    .length;
                  return (
                    <div key={key} className="category-stat-item">
                      <span 
                        className="category-color"
                        style={{ backgroundColor: category.color }}
                      ></span>
                      <span className="category-name">{category.name}</span>
                      <span className="category-count">
                        {collectedCount}/{count}
                      </span>
                    </div>
                  );
                })}
              </div>
            </div>
          )}
          
          <div className="stat-card">
            <h3>Á®ÄÊúâÂ∫¶ÂàÜÂ∏É</h3>
            <div className="rarity-stats">
              {Object.entries(rarityMap).map(([rarity, info]) => {
                const count = foodsData.foods.filter(food => food.rarity === rarity).length;
                const collectedCount = foodsData.foods
                  .filter(food => food.rarity === rarity && collectedFoods.includes(food.id))
                  .length;
                return (
                  <div key={rarity} className="rarity-stat-item">
                    <span 
                      className="rarity-dot"
                      style={{ backgroundColor: info.color }}
                    ></span>
                    <span className="rarity-name">{info.name}</span>
                    <span className="rarity-count">
                      {collectedCount}/{count}
                    </span>
                  </div>
                );
              })}
            </div>
          </div>
        </div>

        {/* Á≠õÈÄâÂíåÊêúÁ¥¢ */}
        <div className="encyclopedia-filters">
          <div className="filter-group">
            <label>Á±ªÂà´:</label>
            <select 
              value={selectedCategory} 
              onChange={(e) => setSelectedCategory(e.target.value)}
            >
              <option value="all">ÂÖ®ÈÉ®</option>
              {foodsData.categories && Object.entries(foodsData.categories).map(([key, category]) => (
                <option key={key} value={key}>{category.name}</option>
              ))}
            </select>
          </div>
          
          <div className="filter-group">
            <label>SDGÁõÆÊ†á:</label>
            <select 
              value={selectedSDG} 
              onChange={(e) => setSelectedSDG(e.target.value)}
            >
              <option value="all">ÂÖ®ÈÉ®</option>
              {availableSDGs.map(sdg => (
                <option key={sdg} value={sdg}>
                  {sdgGoals[sdg]?.icon} {sdgGoals[sdg]?.name}
                </option>
              ))}
            </select>
          </div>
          
          <div className="filter-group">
            <label>ÊêúÁ¥¢:</label>
            <input
              type="text"
              placeholder="ÊêúÁ¥¢È£üÊùê..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
            />
          </div>
          
          <div className="filter-group">
            <label>ÊéíÂ∫è:</label>
            <select 
              value={sortBy} 
              onChange={(e) => setSortBy(e.target.value)}
            >
              <option value="name">ÂêçÁß∞</option>
              <option value="rarity">Á®ÄÊúâÂ∫¶</option>
              <option value="sdg">SDGÊï∞Èáè</option>
            </select>
          </div>
        </div>

        {/* È£üÊùêÂàóË°® */}
        <div className={`encyclopedia-content ${viewMode}`}>
          <AnimatePresence>
            {filteredFoods.map(food => renderFoodCard(food))}
          </AnimatePresence>
        </div>

        {/* È£üÊùêËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü */}
        <AnimatePresence>
          {selectedFood && renderFoodDetail(selectedFood)}
        </AnimatePresence>
      </motion.div>
    </motion.div>
  );
};

export default Encyclopedia;